{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

      <title>Document</title>
</head>
<body>
      <div class="container">
            <div class="row my-5">
                  <div class="col">
                        <div class="card my-auto mx-auto">
                              <div class="card-header">
                              welcome page
                              </div>
                              <div class="card-body">
                                    <h5 class="card-title">Welcome {{ request.user.get_username }} </h5>
                                    <p class="card-text">Lorem ipsum dolor sit amet consectetur adipisicing elit.</p>
                                    {% if request.user.is_authenticated %}
                                          <a href="{% url 'logout' %}" class="btn btn-primary">Sign out</a>
                                          <a href="{% url 'comment-add' %}" class="btn btn-primary">Add comment</a>
                                    {% else %}
                                          <a href="{% url 'login' %}" class="btn btn-primary">Sign in</a>
                                    {% endif %}
                                   
                              </div>
                        </div>
                  </div>
                  {% if request.user.is_authenticated %}
                        <div class="col">
                              <div class="card my-auto mx-auto" id="wrapper">
                                    <div class="card-header">
                                    my comments
                                    </div>

                              </div>
                        </div>
                  {% endif %}
            </div>
      </div>

      <script>

            function getCookie(name) {
		    var cookieValue = null;
		    if (document.cookie && document.cookie !== '') {
		        var cookies = document.cookie.split(';');
		        for (var i = 0; i < cookies.length; i++) {
		            var cookie = cookies[i].trim();
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}
		var csrftoken = getCookie('csrftoken');

            function commentDelete(item){
                  fetch(`http://127.0.0.1:8000/api/comment-delete/${item.id}`, {
                        method: 'DELETE',
                        headers:  {
                              'Content-type': 'application/json',
                              'X-CSRFToken': csrftoken
                        }
                  }).then((response) => {
                        commentList()
                  })
            }

            var list_snapshot = []
            commentList()
            
            function commentList(){
                  var wrapper = document.getElementById('wrapper')

                  var url = 'http://127.0.0.1:8000/api/comment-list'


                  fetch(url)
                  .then((resp) => resp.json())
                  .then(function(data){
                        console.log('Data', data)
                        var list = data
                        var userId = "{{ request.user.id }}"
                        var user_list = []
                        var edit_url = 'http://127.0.0.1:8000/comments/edit'
                        for ( i in list){
                              if (userId == list[i].user){
                                    user_list.push(list[i])
                              }
                        }

                        for (var i in user_list){

                              try{
                                    document.getElementById(`data-${i}`).remove()
                              }catch(err){

                              }

                              var item = `
                                          <div id="data-${i}" class="card-body">
                                                <div class='d-flex justify-content-between'>
                                                      <h5 class="card-title"> ${user_list[i].title}</h5>
                                                      <div>
                                                            <a href='${edit_url + "/" + user_list[i].id}' class='btn btn-sm btn-primary'>Edit comment</a>
                                                            <button class='btn btn-sm btn-danger btn-delete'>Delete comment</button>
                                                      </div>
                                                </div>
                                                <br>
                                                <p class="card-text">${user_list[i].content}</p>
                                                <hr style='margin: -.2rem 0;'>
                                          </div>
                                    `
                                    wrapper.innerHTML += item
                        }
                        
                        if(list_snapshot.length > user_list.length){
                              for(var i = user_list.length; i < list_snapshot.length; i++){
                                    document.getElementById(`data-${i}`).remove()
                              }
                        }
                        list_snapshot = user_list

                        for (i in user_list){
                              var btn = document.getElementsByClassName('btn-delete')[i]
                              btn.addEventListener('click', (function(item){
                                    return function(){
                                          commentDelete(item)
                                    }
                              })(user_list[i]))
                        }

                       
                  })
            }



      </script>
</body>
</html>